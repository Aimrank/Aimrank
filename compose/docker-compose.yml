version: "3.5"

services:
  nginx:
    image: nginx:1.19
    volumes:
      - ../nginx/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - 80:80
    restart: always
    
  cluster:
    image: ghcr.io/aimrank/aimrank-cluster:local
    build:
      context: ../Aimrank.Cluster
      dockerfile: Dockerfile
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    command: [ "sh", "-c", "dotnet Aimrank.Cluster.Migrator.dll && dotnet Aimrank.Cluster.Api.dll" ]

  pod:
    image: ghcr.io/aimrank/aimrank-pod:local
    build:
      context: ../Aimrank.Pod
      dockerfile: Dockerfile
    ports:
      - 30001-30004:30001-30004/udp
      - 30001-30004:30001-30004/tcp
    volumes:
      - ../Aimrank.Pod/container_data:/home/steam/csgo
    depends_on:
      cluster:
        condition: service_started

  web:
    image: ghcr.io/aimrank/aimrank-web:local
    build:
      context: ../Aimrank.Web
      dockerfile: Dockerfile
    volumes:
      - ../Aimrank.Web/src/Aimrank.Web.App/wwwroot:/app/wwwroot
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_started
    command: [ "sh", "-c", "dotnet Aimrank.Web.Database.Migrator.dll && dotnet Aimrank.Web.App.dll" ]

  redis:
    image: redis:6.0.10-alpine
    ports:
      - 6379:6379

  rabbitmq:
    image: rabbitmq:3.8.9-management
    ports:
      - 5672:5672
      - 15672:15672
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
      interval: 5s
      timeout: 5s
      retries: 10

  db:
    image: postgres
    environment:
      - POSTGRES_PASSWORD=aimrank
    ports:
      - 5432:5432
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../postgres:/docker-entrypoint-initdb.d
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U aimrank" ]
      interval: 5s
      timeout: 5s
      retries: 5
      
  mailhog:
    image: mailhog/mailhog
    ports:
      - 1025:1025
      - 8025:8025

volumes:
  postgres_data:
